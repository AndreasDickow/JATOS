var jatos={};!function(){"use strict";jatos.version="3.7.5-alpha",jatos.httpTimeout=3e4,jatos.httpRetry=5,jatos.httpRetryWait=1e3,jatos.studyJsonInput={},jatos.studyLength=null,jatos.studyProperties={},jatos.studySessionData={},jatos.componentList=[],jatos.componentJsonInput={},jatos.componentPos=null,jatos.componentProperties={},jatos.batchProperties={},jatos.batchJsonInput={},jatos.groupMemberId=null,jatos.groupResultId=null,jatos.groupMembers=[],jatos.groupChannels=[];var t={},e={};jatos.channelSendingTimeoutTime=1e4,jatos.channelHeartbeatInterval=25e3,jatos.channelHeartbeatTimeoutTime=1e4,jatos.channelClosedCheckInterval=2e3,jatos.channelOpeningBackoffTimeMin=1e3,jatos.channelOpeningBackoffTimeMax=12e4,jatos.waitSendDataOverlayConfig={text:"Sending data. Please wait."},jatos.studyRunInvalidOverlayConfig={text:"This study run is invalid.",showImg:!1};var o,n,s,a,r,i,u,c,l,d,p={},j={},f=[],y=[],m=0,h=0;jatos.batchSessionVersioning=!0,jatos.groupSessionVersioning=!0;var v,g,b,S,w,I,T,O,x,E,C,P,D="WebSocket"in window,R=0,L={},N=!1,A=!1,k=!1,M=!1,Q=!1,J=new Event("jatosOnLoad"),U=!0;function W(t,e,o){if(!N)return jatos.jQuery.Deferred().reject();var n=jatos.jQuery.Deferred();n.done((function(){rt(e)})),n.fail((function(t){ut(o,t)}));var s=R++;return t.id=s,L[t.id]=n,lt(E)||(E=jatos.jQuery.Deferred()),g.postMessage(t),n}function B(t){var e={};return t.forEach((function(t){var o=t.split("="),n=decodeURIComponent(o[1]);e[o[0]]=n})),e}function G(){return jatos.jQuery.ajax({url:st("initData"),type:"GET",dataType:"json",timeout:jatos.httpTimeout,success:V,error:function(t){ut(null,it(t))}}).retry({times:jatos.httpRetry,timeout:jatos.httpRetryWait})}function V(t){jatos.batchProperties=t.batchProperties,void 0!==jatos.batchProperties.jsonData?jatos.batchJsonInput=jatos.jQuery.parseJSON(jatos.batchProperties.jsonData):jatos.batchJsonInput={},delete jatos.batchProperties.jsonData;try{jatos.studySessionData=JSON.parse(t.studySessionData)}catch(t){ut(null,t.stack||t)}jatos.studyProperties=t.studyProperties,void 0!==jatos.studyProperties.jsonData&&null!==jatos.studyProperties.jsonData?jatos.studyJsonInput=jatos.jQuery.parseJSON(jatos.studyProperties.jsonData):jatos.studyJsonInput={},delete jatos.studyProperties.jsonData,jatos.componentList=t.componentList,jatos.studyLength=t.componentList.length,jatos.componentProperties=t.componentProperties,void 0!==jatos.componentProperties.jsonData&&null!==jatos.componentProperties.jsonData?jatos.componentJsonInput=jatos.jQuery.parseJSON(jatos.componentProperties.jsonData):jatos.componentJsonInput={},delete jatos.componentProperties.jsonData,jatos.urlQueryParameters=t.urlQueryParameters,jatos.studyCode=t.studyCode}function F(){!A&&N&&(A=!0,window.dispatchEvent(J))}function H(t){return"number"!=typeof t&&(t=jatos.channelOpeningBackoffTimeMin),function(){if(!D)return ut(null,"This browser does not support WebSockets. Can't open batch channel."),dt();if(c&&c.readyState!=c.CLOSED)return dt();if(Q)return ut(null,"This study run is invalid."),dt();if(lt(b))return ut(null,"Can open only one batch channel."),dt();return b=jatos.jQuery.Deferred(),(c=new WebSocket(("https:"===window.location.protocol?"wss://":"ws://")+window.location.host+jatos.urlBasePath+"publix/"+jatos.studyResultUuid+"/batch/open")).onopen=function(){clearInterval(n),n=setInterval((function(){if(c.readyState==c.OPEN){c.send('{"heartbeat":"ping"}');var t=setTimeout((function(){ut(null,"Batch channel heartbeat fail"),_()}),jatos.channelHeartbeatTimeoutTime);f.push(t)}}),jatos.channelHeartbeatInterval),clearInterval(a),a=setInterval((function(){c.readyState==c.CLOSED&&(ut(null,"Batch channel closed unexpectedly"),clearInterval(a),_())}),jatos.channelClosedCheckInterval)},c.onmessage=function(t){!function(t){var o;try{o=JSON.parse(t)}catch(t){return void ut(null,t)}if(void 0!==o.heartbeat)return void q();void 0!==o.patches&&("remove"==o.patches[0].op&&"/"==o.patches[0].path?e={}:jsonpatch.apply(e,o.patches));void 0!==o.data&&(e=null===o.data?{}:o.data);void 0!==o.version&&(i=o.version,lt(b)&&b.resolve());void 0!==o.action&&function(t){switch(t.action){case"SESSION":t.patches.forEach((function(t){rt(C,t.path,t.op)}));break;case"SESSION_ACK":p.hasOwnProperty(t.id)?p[t.id].cancel():ut(null,"Batch session got 'SESSION_ACK' with nonexistent ID "+t.id);break;case"SESSION_FAIL":p.hasOwnProperty(t.id)?p[t.id].trigger():ut(null,"Batch session got 'SESSION_FAIL' with nonexistent ID "+t.id);break;case"CLOSED":clearInterval(a),Q=!0,jatos.showOverlay(jatos.studyRunInvalidOverlayConfig);break;case"ERROR":ut(null,t.errorMsg);break}}(o)}(t.data)},c.onerror=function(){ut(null,"Batch channel error"),b.reject()},c.onclose=function(){z(),b.reject()},b.promise()}().fail((function(){t<jatos.channelOpeningBackoffTimeMax&&(t*=2),setTimeout((function(){H(t)}),t)}))}function _(){lt(b)||(c instanceof WebSocket&&c.close(),z(),H())}function z(){e={},i=null,q(),clearInterval(n)}function q(){f.forEach((function(t){clearTimeout(t)})),f=[]}function K(t,e,o,n){var s={};return s.op=t,null!==e&&(s.path=e),null!==o&&(s.value=o),null!==n&&(s.from=n),s}function X(t,e,o){if(!c||c.readyState!=c.OPEN)return ut(o,"No open batch channel"),dt();if(jatos.batchSessionVersioning&&lt(S))return ut(o,"Can send only one batch session patch at a time"),dt();if(Q)return ut(o,"This study run is invalid."),dt();var n=jatos.jQuery.Deferred();jatos.batchSessionVersioning&&(S=n);var s=m++,a={action:"SESSION"};a.id=s,a.patches=t.constructor===Array?t:[t],a.version=i,a.versioning=!!jatos.batchSessionVersioning;try{c.send(JSON.stringify(a)),ct(n,p,s,e,o)}catch(t){ut(o,t),n.reject()}return n.promise()}function Y(t,e,o,n){if(Q)return ut(n,"This study run is invalid."),dt();var s=e?"POST":"PUT";return t===Object(t)&&(t=JSON.stringify(t)),W({url:st("resultData"),data:t,method:s,contentType:"text/plain; charset=UTF-8",timeout:jatos.httpTimeout,retry:jatos.httpRetry,retryWait:jatos.httpRetryWait},o,n).promise()}function Z(){return D?l&&l.readyState!=l.CLOSED?dt():Q?(ut(d.onError,"This study run is invalid."),dt()):lt(w)?(ut(d.onError,"Can open group channel only once"),dt()):lt(x)?(ut(d.onError,"Can't open group channel while leaving a group"),dt()):lt(O)?(ut(d.onError,"Can't open group channel while reassigning a group"),dt()):(w=jatos.jQuery.Deferred(),(l=new WebSocket(("https:"===window.location.protocol?"wss://":"ws://")+window.location.host+jatos.urlBasePath+"publix/"+jatos.studyResultUuid+"/group/join")).onopen=function(){clearInterval(s),s=setInterval((function(){if(l.readyState==l.OPEN){l.send('{"heartbeat":"ping"}');var t=setTimeout((function(){ut(d.onError,"Group channel heartbeat fail"),tt()}),jatos.channelHeartbeatTimeoutTime);y.push(t)}}),jatos.channelHeartbeatInterval),clearInterval(r),r=setInterval((function(){l.readyState==l.CLOSED&&(ut(d.onError,"Group channel closed unexpectedly"),clearInterval(r),tt())}),jatos.channelClosedCheckInterval)},l.onmessage=function(e){!function(e){var n;try{n=JSON.parse(e)}catch(t){return void ut(d.onError,t)}if(void 0!==n.heartbeat)return void et();(function(e){void 0!==e.groupResultId&&(jatos.groupResultId=e.groupResultId.toString(),jatos.groupMemberId=jatos.studyResultId);void 0!==e.members&&(jatos.groupMembers=e.members);void 0!==e.channels&&(jatos.groupChannels=e.channels);void 0!==e.sessionPatches&&("remove"==e.sessionPatches[0].op&&"/"==e.sessionPatches[0].path?t={}:jsonpatch.apply(t,e.sessionPatches));void 0!==e.sessionData&&(t=null===e.sessionData?{}:e.sessionData);void 0!==e.sessionVersion&&(u=e.sessionVersion,lt(w)&&w.resolve())})(n),function(t){if(!t.action)return;switch(t.action){case"OPENED":t.memberId==jatos.groupMemberId?rt(d.onOpen,t.memberId):(rt(d.onMemberOpen,t.memberId),rt(d.onUpdate));break;case"CLOSED":void 0!==t.memberId&&t.memberId!=jatos.groupMemberId?(rt(d.onMemberClose,t.memberId),rt(d.onUpdate)):clearInterval(r);break;case"JOINED":t.memberId!=jatos.groupMemberId&&(rt(d.onMemberJoin,t.memberId),rt(d.onUpdate));break;case"LEFT":t.memberId!=jatos.groupMemberId&&(rt(d.onMemberLeave,t.memberId),rt(d.onUpdate));break;case"SESSION":t.sessionPatches.forEach((function(t){rt(d.onGroupSession,t.path,t.op)})),rt(d.onUpdate);break;case"FIXED":o&&o.cancel(),rt(d.onUpdate);break;case"SESSION_ACK":j.hasOwnProperty(t.sessionActionId)?j[t.sessionActionId].cancel():ut(null,"Group session got 'SESSION_ACK' with nonexistent ID "+t.sessionActionId);break;case"SESSION_FAIL":j.hasOwnProperty(t.sessionActionId)?j[t.sessionActionId].trigger():ut(null,"Group session got 'SESSION_FAIL' with nonexistent ID "+t.sessionActionId);break;case"ERROR":ut(d.onError,t.errorMsg);break}}(n),n.msg&&d.onMessage&&d.onMessage(n.msg)}(e.data)},l.onerror=function(){ut(d.onError,"Group channel error"),w.reject()},l.onclose=function(){ot(),rt(d.onClose),w.reject()},w.promise()):(ut(d.onError,"This browser does not support WebSockets."),dt())}function $(t){"number"!=typeof t&&(t=jatos.channelOpeningBackoffTimeMin),Z().fail((function(){t<jatos.channelOpeningBackoffTimeMax&&(t*=2),setTimeout((function(){$(t)}),t)}))}function tt(){lt(w)||lt(O)||lt(x)||(l&&l.readyState!=l.CLOSED&&l.close(),ot(),$())}function et(){y.forEach((function(t){clearTimeout(t)})),y=[]}function ot(){jatos.groupMemberId=null,jatos.groupResultId=null,jatos.groupMembers=[],jatos.groupChannels=[],t={},u=null,et(),clearInterval(s)}function nt(t,e,o){if(!l||l.readyState!=l.OPEN)return ut(o,"No open group channel"),dt();if(jatos.groupSessionVersioning&&lt(I))return ut(o,"Can send only one group session patch at a time"),dt();if(Q)return ut(o,"This study run is invalid."),dt();var n=jatos.jQuery.Deferred();jatos.groupSessionVersioning&&(I=n);var s=h++,a={action:"SESSION"};a.sessionActionId=s,a.sessionPatches=t.constructor===Array?t:[t],a.sessionVersion=u,a.sessionVersioning=!!jatos.groupSessionVersioning;try{l.send(JSON.stringify(a)),ct(n,j,s,e,o)}catch(t){ut(o,t),n.reject()}return n.promise()}function st(t){return new URL(t,window.location.href).toString()}jatos.jQuery={},function(t,e){var o=document.createElement("script");o.src=t;var n=document.getElementsByTagName("head")[0],s=!1;o.onload=o.onreadystatechange=function(){s||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(s=!0,e(),o.onload=o.onreadystatechange=null,n.removeChild(o))},n.appendChild(o)}("jatos-publix/javascripts/jquery-3.5.1.min.js",(function(){jatos.jQuery=jQuery.noConflict(!0),jatos.jQuery.ajaxSetup({cache:!0}),jatos.jQuery.when(jatos.jQuery.getScript("jatos-publix/javascripts/jquery.ajax-retry.min.js"),jatos.jQuery.getScript("jatos-publix/javascripts/json-patch-duplex.min.js"),jatos.jQuery.getScript("jatos-publix/javascripts/jsonpointer.min.js")).then((function(){jatos.studyResultUuid=window.location.pathname.split("/").reverse()[2],function(){for(var t="JATOS_IDS",e=document.cookie.split(";"),o=function(t,e){jatos[t]=e},n=0;n<e.length;n++){for(var s=e[n];" "===s.charAt(0);)s=s.substring(1,s.length);if(0===s.indexOf(t)){var a=B(s.substr(s.indexOf(t)+t.length+3,s.length).split("&"));if(a.studyResultUuid==jatos.studyResultUuid){jatos.jQuery.each(a,o),jatos.componentPos=parseInt(jatos.componentPos);break}}}}(),(v=new Worker("jatos-publix/javascripts/heartbeat.js")).postMessage([jatos.studyResultUuid]),(g=new Worker("jatos-publix/javascripts/httpLoop.js")).addEventListener("message",(function(t){!function(t){var e=L[t.requestId];if(delete L[t.requestId],200==t.status)e.resolve();else{var o=[t.status,t.statusText,t.error].filter((function(t){return t})).join(", ");e.reject(t.method+" to "+t.url+" failed: "+o)}0===Object.keys(L).length&&lt(E)&&E.resolve()}(t.data)}),!1)})).then(G).then(H).always((function(){N=!0,F()}))})),jatos.onLoad=function(t){A?t():(window.addEventListener("jatosOnLoad",t),F())},jatos.onload=jatos.onLoad,jatos.batchSession={},jatos.batchSession.get=function(t){return jt(jsonpointer.get(e,"/"+t))},jatos.batchSession.getAll=function(){return jt(jatos.batchSession.find(""))},jatos.batchSession.find=function(t){return jt(jsonpointer.get(e,t))},jatos.batchSession.test=function(t,o){return jsonpointer.get(e,t)===o},jatos.batchSession.defined=function(t){return!jatos.batchSession.test(t,void 0)},jatos.batchSession.add=function(t,e,o,n){return X(K("add",t,e,null),o,n)},jatos.batchSession.set=function(t,e,o,n){return X(K("add","/"+t,e,null),o,n)},jatos.batchSession.setAll=function(t,e,o){return jatos.batchSession.replace("",t,e,o)},jatos.batchSession.remove=function(t,e,o){return X(K("remove",t,null,null),e,o)},jatos.batchSession.clear=function(t,e){return X(K("remove","/",null,null),t,e)},jatos.batchSession.replace=function(t,e,o,n){return X(K("replace",t,e,null),o,n)},jatos.batchSession.copy=function(t,e,o,n){return X(K("copy",e,null,t),o,n)},jatos.batchSession.move=function(t,e,o,n){return X(K("move",e,null,t),o,n)},jatos.setHeartbeatPeriod=function(t){"number"==typeof t&&v&&v.postMessage([jatos.studyResultUuid,t])},jatos.onBatchSession=function(t){C=t},jatos.onError=function(t){P=t},jatos.submitResultData=function(t,e,o){return Y(t,!1,e,o)},jatos.appendResultData=function(t,e,o){return Y(t,!0,e,o)},jatos.uploadResultFile=function(t,e,o,n){if(Q)return ut(n,"This study run is invalid."),dt();if("string"!=typeof e||0===e.length)return ut(n,"No filename specified"),dt();var s;if(t instanceof Blob)s=t;else if("string"==typeof t)s=new Blob([t],{type:"text/plain"});else{if(t!==Object(t))return ut(n,"Only string, Object or Blob allowed"),dt();s=new Blob([JSON.stringify(t,null,2)],{type:"application/json"})}return W({url:st("files/"+encodeURI(e)),blob:s,filename:e,method:"POST",timeout:jatos.httpTimeout,retry:jatos.httpRetry,retryWait:jatos.httpRetryWait},o,n).promise()},jatos.downloadResultFile=function(t,e,o,n){if(!N)return dt();var s,a,r,i;if("number"==typeof t)s=t,a=e,r=o,i=n;else{if("string"!=typeof t)return ut(i,"Unknown first parameter"),dt();a=t,r=e,i=o}if(Q)return ut(i,"This study run is invalid."),dt();if("string"!=typeof a||0===a.length)return ut(i,"No filename specified"),dt();var u=st("../files/"+encodeURI(a));if(s){if(pt(s))return ut(i,"Component position does not exist"),dt();u+="?componentId="+jatos.componentList[s-1].id}var c=jatos.jQuery.Deferred(),l=new XMLHttpRequest;return l.open("GET",u,!0),l.responseType="blob",l.onload=function(){if(200==this.status){var t=l.response;if("application/json"==t.type){var e=new FileReader;e.addEventListener("loadend",(function(){var t=JSON.parse(e.result);rt(r,t),c.resolve(t)})),e.readAsText(t)}else if("text/plain"==t.type){var o=new FileReader;o.addEventListener("loadend",(function(){var t=o.result;rt(r,t),c.resolve(t)})),o.readAsText(t)}else rt(r,t),c.resolve(t)}else l.onerror()},l.onerror=function(){var t="Download of "+a+" returned "+l.statusText;ut(i,t),c.reject(t)},l.send(null),c.promise()},jatos.setStudySessionData=function(t,e,o){jatos.studySessionData=t;var n=JSON.stringify(t);return W({url:st("../studySessionData"),data:n,method:"POST",contentType:"text/plain; charset=UTF-8",timeout:jatos.httpTimeout,retry:jatos.httpRetry,retryWait:jatos.httpRetryWait},e,o).promise()},jatos.startComponent=function(t,e,o,n){var s,a,r;if(N)if(r="number"==typeof t?jatos.componentList.find((e=>e.id==t)).uuid:t,"string"==typeof o?(s=o,a=n):"function"==typeof o&&(a=o),Q)ut(a,"This study run is invalid.");else if(k)ut(a,"Can start only one component at the same time");else{k=!0,e&&jatos.appendResultData(e),jatos.setStudySessionData(jatos.studySessionData);var i=function(){window.removeEventListener("beforeunload",at,{capture:!0});var t=st("../"+r+"/start");s&&(t=t+"?"+jatos.jQuery.param({message:s})),window.location.href=t};lt(E)?(setTimeout(jatos.showOverlay,1e3,jatos.waitSendDataOverlayConfig),E.always(i)):i()}},jatos.startComponentByPos=function(t,e,o,n){var s;if(pt(t))return"function"==typeof o?s=o:"function"==typeof n&&(s=n),void ut(s,"Component position does not exist");var a=jatos.componentList[t-1].uuid;jatos.startComponent(a,e,o,n)},jatos.startNextComponent=function(t,e,o){var n,s;"string"==typeof e?(n=e,s=o):s=e;var a=jatos.componentList.slice().reverse().find((function(t){return t.active}));if(jatos.componentPos>=a.position)if(t){jatos.appendResultData(t).done((function(){jatos.endStudy(!0,n)})).fail(s)}else jatos.endStudy(!0,n);else for(var r=jatos.componentPos;r<jatos.componentList.length;r++)if(jatos.componentList[r].active){var i=jatos.componentList[r].uuid;jatos.startComponent(i,t,e,o);break}},jatos.startLastComponent=function(t,e,o){var n=jatos.componentList.reverse().find((t=>t.active));jatos.startComponent(n.uuid,t,e,o)},jatos.joinGroup=function(t){return d=t||{},Z()},jatos.groupSession={},jatos.groupSession.get=function(e){return jt(jsonpointer.get(t,"/"+e))},jatos.groupSession.getAll=function(){return jt(jatos.groupSession.find(""))},jatos.groupSession.find=function(e){return jt(jsonpointer.get(t,e))},jatos.groupSession.test=function(e,o){return jsonpointer.get(t,e)===o},jatos.groupSession.defined=function(t){return!jatos.groupSession.test(t,void 0)},jatos.groupSession.add=function(t,e,o,n){return nt(K("add",t,e,null),o,n)},jatos.groupSession.set=function(t,e,o,n){return nt(K("add","/"+t,e,null),o,n)},jatos.groupSession.setAll=function(t,e,o){return jatos.groupSession.replace("",t,e,o)},jatos.groupSession.remove=function(t,e,o){return nt(K("remove",t,null,null),e,o)},jatos.groupSession.clear=function(t,e){return nt(K("remove","/",null,null),t,e)},jatos.groupSession.replace=function(t,e,o,n){return nt(K("replace",t,e,null),o,n)},jatos.groupSession.copy=function(t,e,o,n){return nt(K("copy",e,null,t),o,n)},jatos.groupSession.move=function(t,e,o,n){return nt(K("move",e,null,t),o,n)},jatos.setGroupFixed=function(t,e){if(!l||l.readyState!=l.OPEN)return ut(e,"No open group channel"),dt();if(lt(T))return ut(e,"Can fix group only once"),dt();if(Q)return ut(e,"This study run is invalid."),dt();T=jatos.jQuery.Deferred();var n={action:"FIXED"};try{l.send(JSON.stringify(n)),function(t,e,n){var s=setTimeout((()=>{rt(n,"Timeout sending message"),t.reject("Timeout sending message")}),jatos.channelSendingTimeoutTime);o={cancel:()=>{clearTimeout(s),rt(e,"success"),t.resolve("success")}},t.always((()=>{o=null}))}(T,t,e)}catch(t){ut(e,t),T.reject()}return T.promise()},jatos.hasJoinedGroup=function(){return null!==jatos.groupResultId},jatos.hasOpenGroupChannel=function(){return l&&l.readyState==l.OPEN},jatos.isMaxActiveMemberReached=function(){return!(!jatos.batchProperties||null===jatos.batchProperties.maxActiveMembers)&&jatos.groupMembers.length>=jatos.batchProperties.maxActiveMembers},jatos.isMaxActiveMemberOpen=function(){return!(!jatos.batchProperties||null===jatos.batchProperties.maxActiveMembers)&&jatos.groupChannels.length>=jatos.batchProperties.maxActiveMembers},jatos.isGroupOpen=function(){return!(!l||l.readyState!=l.OPEN)&&jatos.groupMembers.length==jatos.groupChannels.length},jatos.sendGroupMsg=function(t){if(l&&l.readyState==l.OPEN){var e={};e.msg=t,l.send(JSON.stringify(e))}},jatos.sendGroupMsgTo=function(t,e){if(l&&l.readyState==l.OPEN){var o={};o.recipient=t,o.msg=e,l.send(JSON.stringify(o))}},jatos.reassignGroup=function(t,e){return lt(w)?(ut(e,"Can't reassign group if not joined yet"),dt()):lt(x)?(ut(e,"Can't reassign group during leaving"),dt()):lt(O)?(ut(e,"Can't reassign group twice at the same time"),dt()):l&&l.readyState!=l.OPEN?(ut(e,"Group channel not open"),dt()):Q?(ut(e,"This study run is invalid."),dt()):(O=jatos.jQuery.Deferred(),jatos.jQuery.ajax({url:st("../group/reassign"),processData:!1,type:"GET",timeout:jatos.httpTimeout,statusCode:{200:function(){rt(t),O.resolve()},204:function(){rt(e),O.reject()}},error:function(t){var o=it(t);ut(e,it(t)),O.reject(o)}}),O.promise())},jatos.leaveGroup=function(t,e){return lt(w)?(ut(e,"Can't leave group if not joined yet"),dt()):lt(O)?(ut(e,"Can't leave group during reassigning"),dt()):lt(x)?(ut(e,"Can leave only once"),dt()):Q?(ut(e,"This study run is invalid."),dt()):(x=jatos.jQuery.Deferred(),jatos.jQuery.ajax({url:st("../group/leave"),processData:!1,type:"GET",timeout:jatos.httpTimeout,success:function(e){clearInterval(r),rt(t,e),x.resolve(e)},error:function(t){var o=it(t);ut(e,it(t)),x.reject(o)}}).retry({times:jatos.httpRetry,timeout:jatos.httpRetryWait}),x.promise())},jatos.abortStudyAjax=function(t,e,o){if(!N)return ut(o,"jatos.js not yet initialized"),dt();if(Q)return ut(o,"This study run is invalid."),dt();if(M)return ut(o,"Can end/abort study only once"),dt();M=!0;var n=st("../abort");void 0!==t&&(n=n+"?message="+t);var s={url:n,method:"GET",timeout:jatos.httpTimeout,retry:jatos.httpRetry,retryWait:jatos.httpRetryWait};jatos.showBeforeUnloadWarning(!1);var i=W(s,e,o);return setTimeout((function(){lt(E)&&lt(i)&&jatos.showOverlay(jatos.waitSendDataOverlayConfig)}),1e3),i.done((function(){window.removeEventListener("beforeunload",at,{capture:!0}),v.terminate(),g.terminate(),clearInterval(a),clearInterval(r)})),i.always(jatos.removeOverlay),i.promise()},jatos.abortStudy=function(t,e){if(void 0!==e&&!e)return jatos.abortStudyAjax(t);function o(){window.removeEventListener("beforeunload",at,{capture:!0});var e=st("../abort");window.location.href=void 0===t?e:e+"?message="+t}Q?ut(null,"This study run is invalid."):M?ut(null,"Can end/abort study only once"):(M=!0,lt(E)?(setTimeout(jatos.showOverlay,1e3,jatos.waitSendDataOverlayConfig),E.always(o)):o())},jatos.endStudyAjax=function(t,e,o,n,s){if(!N)return dt();var i,u,c,l,d;if("string"==typeof t||"object"==typeof t?(i=t,u=e,c=o,l=n,d=s):"boolean"==typeof t&&(u=t,c=e,l=o,d=n),Q)return ut(d,"This study run is invalid."),dt();if(M)return ut(d,"Can end/abort study only once"),dt();M=!0,i&&jatos.appendResultData(i);var p=st("../end");"boolean"==typeof u&&"string"==typeof c?p=p+"?"+jatos.jQuery.param({successful:u,message:c}):"boolean"==typeof u&&"string"!=typeof c?p=p+"?"+jatos.jQuery.param({successful:u}):"boolean"!=typeof u&&"string"==typeof c&&(p=p+"?"+jatos.jQuery.param({message:c}));var j={url:p,method:"GET",timeout:jatos.httpTimeout,retry:jatos.httpRetry,retryWait:jatos.httpRetryWait};jatos.showBeforeUnloadWarning(!1);var f=W(j,l,d);return setTimeout((function(){lt(E)&&lt(f)&&jatos.showOverlay(jatos.waitSendDataOverlayConfig)}),1e3),f.done((function(){window.removeEventListener("beforeunload",at,{capture:!0}),v.terminate(),g.terminate(),clearInterval(a),clearInterval(r)})),f.always(jatos.removeOverlay),f.promise()},jatos.endStudyAndRedirect=function(t,e,o,n,s,a){jatos.endStudyAjax(e,o,n,s,a).done((function(){window.location.href=t}))},jatos.endStudy=function(t,e,o,n){if(N)if(Q)ut(null,"This study run is invalid.");else{var s,a,r,i;if("string"==typeof t||"object"==typeof t?(s=t,a=e,r=o,i=n):"boolean"==typeof t&&(a=t,r=e,i=o),void 0!==i&&!i)return s?jatos.endStudyAjax(s,a,r):jatos.endStudyAjax(a,r);M?ut(null,"Can end/abort study only once"):(M=!0,s&&jatos.appendResultData(s),lt(E)?(setTimeout(jatos.showOverlay,1e3,jatos.waitSendDataOverlayConfig),E.always(u)):u())}else ut(null,"jatos.js not yet initialized");function u(){window.removeEventListener("beforeunload",at,{capture:!0});var t=st("../end");"boolean"==typeof a&&"string"==typeof r?t=t+"?"+jatos.jQuery.param({successful:a,message:r}):"boolean"==typeof a&&"string"!=typeof r?t=t+"?"+jatos.jQuery.param({successful:a}):"boolean"!=typeof a&&"string"==typeof r&&(t=t+"?"+jatos.jQuery.param({message:r})),window.location.href=t}},jatos.getHttpLoopCounter=function(){return R},jatos.logError=function(t){jatos.log(t)},jatos.log=function(t){N&&W({url:st("log"),method:"POST",data:t,contentType:"text/plain; charset=UTF-8",timeout:jatos.httpTimeout,retry:jatos.httpRetry,retryWait:jatos.httpRetryWait})},jatos.catchAndLogErrors=function(){window.addEventListener("error",(function(t){jatos.log("Via 'error' event in "+t.filename+":"+t.lineno+" - "+t.message)})),window.addEventListener("unhandledrejection",(function(t){jatos.log("Via 'unhandledrejection' event in "+t.filename+":"+t.lineno+" - "+t.message)}));var t=console.error,e=console.warn;console.error=function(e){jatos.log("Via console.error - "+e),t.apply(this,arguments)},console.warn=function(t){jatos.log("Via console.warn - "+t),e.apply(this,arguments)}},jatos.addJatosIds=function(t){return t.studyCode=jatos.studyCode,t.studyId=jatos.studyId,t.studyTitle=jatos.studyProperties.title,t.batchId=jatos.batchId,t.batchTitle=jatos.batchProperties.title,t.componentId=jatos.componentId,t.componentPos=jatos.componentPos,t.componentTitle=jatos.componentProperties.title,t.workerId=jatos.workerId,t.studyResultId=jatos.studyResultId,t.componentResultId=jatos.componentResultId,t.groupResultId=jatos.groupResultId,t.groupMemberId=jatos.groupMemberId,t},jatos.onLoad((function(){U&&!jatos.componentProperties.reloadable&&window.addEventListener("beforeunload",at,{capture:!0})}));var at=function(t){t.preventDefault(),t.returnValue="Are you sure you want to leave?"};function rt(t,e,o){t&&"function"==typeof t&&t(e,o)}function it(t){return"timeout"==t.statusText?"JATOS server not responding":t.responseText?t.statusText+": "+t.responseText:t.statusText+": Error during Ajax call to JATOS server."}function ut(t,e){t?t(e):P&&P(e)}function ct(t,e,o,n,s){var a=setTimeout((function(){rt(s,"Timeout sending message"),t.reject("Timeout sending message")}),jatos.channelSendingTimeoutTime);e[o]={cancel:function(){clearTimeout(a),rt(n,"success"),t.resolve("success")},trigger:function(){clearTimeout(a),rt(s,"Error sending message"),t.reject("Error sending message")}},t.always((function(){delete e[o]}))}function lt(t){return void 0!==t&&"pending"==t.state()}function dt(){var t=jatos.jQuery.Deferred();return t.reject(),t.promise()}function pt(t){return t<=0||t>jatos.componentList.length}function jt(t){var e;if(null===t||"object"!=typeof t)return t;if(t instanceof Array){e=[];for(var o=0,n=t.length;o<n;o++)e[o]=jt(t[o]);return e}if(t instanceof Object){for(var s in e={},t)t.hasOwnProperty(s)&&(e[s]=jt(t[s]));return e}throw new Error("Unable to copy obj! Its type isn't supported.")}jatos.showBeforeUnloadWarning=function(t){U=t,t?window.addEventListener("beforeunload",at,{capture:!0}):window.removeEventListener("beforeunload",at,{capture:!0})},jatos.showOverlay=function(t){if(!t||"boolean"!=typeof t.show||t.show){var e="color: black;font-family: Sans-Serif;font-size: 30px;letter-spacing: 2px;opacity: 0.6;text-shadow: -1px 0 white, 0 1px white, 1px 0 white, 0 -1px white;z-index: 9999;position: absolute;left: 50%;top: 50%;transform: translate(-50%, -50%);display: flex;align-items: center;justify-content: center;flex-direction: column;";t&&"string"==typeof t.style&&(e+=";"+t.style);var o=document.createElement("div");o.id="jatosOverlay",o.style.cssText=e;var n=t&&"string"==typeof t.text?t.text:"Please wait",s=document.createTextNode(n);if(o.appendChild(s),!t||"boolean"!=typeof t.showImg||t.showImg){var a=t&&"string"==typeof t.imgUrl?t.imgUrl:"jatos-publix/images/waiting.gif",r=document.createElement("img");r.src=a,r.style.marginTop="10px",o.appendChild(r)}jatos.removeOverlay(),document.body.appendChild(o)}},jatos.removeOverlay=function(){var t=document.getElementById("jatosOverlay");t&&t.remove()},jatos.addAbortButton=function(t){var e=t&&"string"==typeof t.text?t.text:"Cancel",o=!t||"boolean"!=typeof t.confirm||t.confirm,n=t&&"string"==typeof t.confirmText?t.confirmText:"Do you really want to cancel this study?",s=t&&"string"==typeof t.tooltip?t.tooltip:"Cancels this study and deletes all already submitted data",a=t&&"string"==typeof t.msg?t.msg:"Worker decided to abort",r="color:black;font-family:Sans-Serif;font-size:20px;letter-spacing:2px;position:fixed;margin:2em 0 0 2em;bottom:1em;right:1em;opacity:0.6;z-index:9999;cursor:pointer;text-shadow:-1px 0 white, 0 1px white, 1px 0 white, 0 -1px white;";t&&"string"==typeof t.style&&(r+=";"+t.style);var i=document.createTextNode(e),u=document.createElement("div");u.appendChild(i),u.style.cssText=r,u.setAttribute("title",s),u.addEventListener("click",(function(){o&&!window.confirm(n)||(t&&"function"==typeof t.action?t.action(a):jatos.abortStudy(a))})),document.body.appendChild(u)}}();
