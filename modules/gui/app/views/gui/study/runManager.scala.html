@(loggedInUser: common.User, breadcrumbs: String, study: common.Study)

@views.html.gui.main(loggedInUser, breadcrumbs){

<button id="createBatchButton" type="button" class="btn btn-primary">New
	Batch</button>

<div class="list-group" id="batchList"></div>

<!-- Create Batch Modal -->
<div class="modal fade" id="createBatchModal" data-backdrop="static"
	data-keyboard="false" tabindex="-1" role="dialog"
	aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form id="createBatchForm" method="post" action="/"
				class="form-horizontal" role="form">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">
						<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
					</button>
					<h4 class="modal-title">Create Batch</h4>
				</div>
				<div class="modal-body">
					<div class="form-group row">
						<label class="control-label col-xs-3"
							for="@models.gui.BatchProperties.TITLE">Title</label>
						<div class="col-xs-9">
							<input type="text"
								class="form-control @models.gui.BatchProperties.TITLE"
								id="@models.gui.BatchProperties.TITLE"
								name="@models.gui.BatchProperties.TITLE"
								placeholder="Your batch title">
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
					<input type="submit" class="confirmed btn btn-primary"
						value="Create">
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Template for batch's row -->
<div id="batchRowTemplateDiv" class="list-group-item"
	style="display: none">
	<button type="button" class="btn btn-sm btn-default activeButton"
		data-toggle="tooltip" data-placement="bottom"
		title="Activates or inactivates this batch: Only in an activated batch a study can be run. An already started study can be finished regardless of this batch was inactivated after the start.">
		<span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
	</button>
	<a class="batchLink" href=""></a>
	<div class="batchBtnGroup btn-group" aria-hidden="true">
		<button type="button" class="batchResults btn btn-info"
			data-toggle="tooltip" data-placement="bottom"
			title="Shows only the results of this batch">
			Results <span class="resultsBadge badge"></span>
		</button>
		<div class="btn-group">
			<button type="button" class="btn btn-info dropdown-toggle"
				data-toggle="dropdown">
				More <span class="caret"></span>
			</button>
			<ul class="dropdown-menu" role="menu">
				<li data-toggle="tooltip" data-placement="bottom"
					title="Deletes this batch but doesn't delete any results"><a
					class="removeBatch" href="#"> <span
						class="glyphicon glyphicon-remove" aria-hidden="true"></span>
						Delete
				</a></li>
			</ul>
		</div>
	</div>
</div>

<script>

loadBatchList();

function loadBatchList() {
	$.ajax({
		type: 'GET',
		url: "@controllers.gui.routes.Batches.batchesByStudy(study.getId())",
		success: function(response) {
			fillBatchList(response);
		},
		error: function(response) {
			showError("Couldn't load batches.");
		}
	});
}

function fillBatchList(batchList) {
	$("#batchList").empty();
	$.each(batchList, function(index, batch) {
		var toolbar = $('#batchRowTemplateDiv').clone().show();
		// Write batch object into toolbar's data attribute so we can use it later on 
		$(toolbar).data(batch);
		setButtonActive($(toolbar).find('.activeButton'), batch.active);
		$(toolbar).find('.batchLink').text(batch.title);
		var url = "/jatos/@study.getId()/batch/" + batch.id;
		$(toolbar).find('.batchLink').attr("href", url)
		$("#batchList").append(toolbar);
	});
}

$('#createBatchButton').click(function(event) {
	removeWarnings("#createBatchModal");
	removeFormErrors("#createBatchModal");
	$('#createBatchModal .@models.gui.BatchProperties.TITLE').val('');
	$('#createBatchModal').modal('show');
});

$("#createBatchForm").submit(function(event) {
	event.preventDefault();
	$.ajax({
		type: 'POST',
		url: "@controllers.gui.routes.Batches.submitCreated(study.getId())",
		data: $('#createBatchForm').serialize(), 
		success: function(response) {
			removeWarnings("#createBatchModal");
			removeFormErrors("#createBatchModal");
			$('#createBatchModal').modal('hide');
			loadBatchList();
		},
		error: function(response) {
			removeWarnings("#createBatchModal");
			removeFormErrors("#createBatchModal");
			showWarning("Batch wasn't created", "#createBatchModal .modal-header");
			showFormErrors("#createBatchModal", response.responseJSON);
		}
	});
});

$('#batchList').on('click', '.activeButton', function() {
	var button = this;
	var batch = getBatchData(this);
	if (!batch) {return} // should never happen
	var active = $(this).hasClass('activeBatch');
	$.ajax({
		url : "/jatos/" + @study.getId() +"/batch/" + batch.id
				+ "/property?active=" + !active,
		type : "POST",
		success: function(response) {
			setButtonActive($(button), response === 'true');
		},
		error : function(err) {
			showError(err.responseText);
		}
	});
});

function setButtonActive(button, active) {
	if (active) {
		button.addClass('activeBatch');
		button.removeClass('btn-warning');
		button.addClass('btn-info');
		button.attr('title', "Click to deactivate this batch");
		button.html($(button.html())
				.removeClass('glyphicon-remove')
				.addClass('glyphicon-ok').prop('outerHTML'));
	} else {
		button.removeClass('activeBatch');
		button.removeClass('btn-info');
		button.addClass('btn-warning');
		button.attr('title', "Click to activate this batch");
		button.html($(button.html())
				.removeClass('glyphicon-ok')
				.addClass('glyphicon-remove').prop('outerHTML'));
	}
}

$('#batchList').on('click', '.removeBatch', function() {
	var element = this;
	var batch = getBatchData(this);
	if (!batch) {return} // should never happen
	var title = "Confirm Delete";
	var preText = "You are about to delete batch \"" + batch.title 
		+ "\" (ID " + batch.id + ").";
	var postText = "Do you want to proceed?";
	askConfirmation(title, preText, null, postText, 'Delete', function() {
		$.ajax({
			url : "/jatos/" + @study.getId() +"/batch/" + batch.id,
			type : 'DELETE',
			success : function(result) {
				showMessages(JSON.parse(result));
				loadBatchList();
			},
			error : function(err) {
				showError(err.responseText);
			}
		});
	});
});

function getBatchData(element) {
	var row = $(element).closest('#batchRowTemplateDiv');
	var batch = row.data();
	return batch;
}

</script>

}
