@(loggedInUser: common.User, breadcrumbs: String, localhost: Boolean, study: common.Study, component: common.Component)

@views.html.gui.main(loggedInUser, breadcrumbs, localhost){

<div id="resultsTable_upperToolbar" class="btn-toolbar" role="toolbar"></div>

<div id="resultsTable_lowerToolbar" class="hidden-xs hidden-sm">
    <div id="resultsTable_select">
        <label for="resultsTable_select">Select <span class="glyphicon glyphicon-info-sign gray-light" data-toggle="tooltip" title="Select or deselect table rows (results)"></span>:</label>
    </div>

    <div id="resultsTable_search">
        <label for="resultsTable_search">Filter <span class="glyphicon glyphicon-info-sign gray-light" data-toggle="tooltip" title="You can filter for table's content (metadata)"></span>:</label>
        <div class="input-group">
            <input type="search" class="form-control" placeholder="" autofocus>
            <div class="input-group-btn">
                <button type="button" class="btn btn-default regex" data-toggle="tooltip" data-placement="bottom" title="Filter by regular expression">RegEx</button>
                <button type="button" class="btn btn-default caseSensitive" data-toggle="tooltip" data-placement="bottom" title="Filter case sensitive">Aa</button>
            </div>
        </div>
        <a class="btn btn-default" role="button" data-toggle="collapse" href=".dtsb-searchBuilder" data-placement="bottom" title="Define complex filter criteria">Filter Builder&nbsp;<span class="caret"></span></a>
    </div>

    <div class="pull-right">
        <div id="resultsTable_customize"></div>
    </div>
</div>

<table id="resultsTable" class="table table-hover table-row-border" cellpadding="0" cellspacing="0" border="0" width="100%">
    <thead>
        <tr>
            <!-- If you change something in the head, change it in the footer too! -->
            <th><span class="glyphicon glyphicon-info-sign gray-light" data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_DATA"/></th>
            <th><span class="glyphicon glyphicon-info-sign gray-light" data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_DATA_SELECTION"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_COMPONENT_RESULT_ID">Comp. Result ID <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="ID of the component this result belongs to">Comp. ID <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="ID of the study result this component result belongs to">Study Result ID <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="UUID of the study result this component result belongs to">Study Result UUID <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="Study code that was used to run this study">Study Code <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_START_TIME_COMPONENT">Start Time <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_END_TIME_COMPONENT">End Time <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_DURATION_COMPONENT">Duration <span class="glyphicon sortLogo gray-light"/></th>
            <th>Batch <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_WORKER_ID">Worker ID <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_WORKER_TYPE">Worker Type <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_GROUP_ID">Group ID <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_COMPONENT_STATE">State <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="Size of the result data">Data Size <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_COMPONENT_FILES">Files (Size) <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_COMPONENT_MESSAGES">Message <span class="glyphicon sortLogo gray-light"/></th>
        </tr>
    </thead>
    <tfoot>
        <tr>
            <!-- If you change something in the footer, change it in the head too! -->
            <th><span class="glyphicon glyphicon-info-sign gray-light" data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_DATA"/></th>
            <th><span class="glyphicon glyphicon-info-sign gray-light" data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_DATA_SELECTION"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_COMPONENT_RESULT_ID">Comp. Result ID  <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="ID of the component this result belongs to">Comp. ID <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="ID of the study result this component result belongs to">Study Result ID <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="UUID of the study result this component result belongs to">Study Result UUID <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="Study code that was used to run this study">Study Code <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_START_TIME_COMPONENT">Start Time <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_END_TIME_COMPONENT">End Time <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_DURATION_COMPONENT">Duration <span class="glyphicon sortLogo gray-light"/></th>
            <th>Batch <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_WORKER_ID">Worker ID <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_WORKER_TYPE">Worker Type <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_GROUP_ID">Group ID <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_COMPONENT_STATE">State <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="Size of the result data">Data Size <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_COMPONENT_FILES">Files (Size) <span class="glyphicon sortLogo gray-light"/></th>
            <th data-toggle="tooltip" title="@general.common.MessagesStrings.RESULTS_COMPONENT_MESSAGES">Message <span class="glyphicon sortLogo gray-light"/></th>
        </tr>
    </tfoot>
</table>

<!-- Component result data Modal -->
<div class="modal fade" id="componentResultDataModal" data-backdrop="static" data-keyboard="true" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xxl">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Component Result Data</h4>
            </div>
            <div class="modal-body">
                <pre><code class="componentResultData">
                </code></pre>
            </div>
        </div>
    </div>
</div>

<script @{helper.CSPNonce.attr}>
var studyId = @study.getId();

var resultsTable;
$(document).ready(function() {
    resultsTable = $('#resultsTable').DataTable({
        "ajax": {
            "url" : "@controllers.gui.routes.ComponentResults.tableDataByComponent(study.getId(),component.getId())",
            "dataType": "text",
            "dataSrc": function(json) {
                return JSON.parse("[" + json + "]");
            },
            "beforeSend": showWaitingModal,
            "error": function (err) {
                if (err.responseText) {
                    showError(err.responseText);
                } else {
                    showError("Cannot read results data.");
                }
            },
            "complete": hideWaitingModal
        },
        "dom": 'lfrtip',
        "order": [[ 2, "desc" ]],
        "lengthMenu": [[10, 25, 50, 100, 250, 500, 1000, 2500, -1], [10, 25, 50, 100, 250, 500, 1000, 2500, "All"]],
        "pageLength": 10,
        "stateSave": true,
        "stateSaveParams": function (settings, data) {
            data.search.search = "";
        },
        "columns": [
            {
                "class": 'details-control',
                "orderable": false,
                "data": null,
                "render": function (data, type, full, meta) {
                    return '<button type="button" class="btn btn-component" data-toggle="tooltip"' +
                       'data-placement="bottom" title="Show/hide result data">' +
                       '<span class="glyphicon glyphicon-chevron-right"></span></button>';
                }
            },
            {
                "data": null,
                "orderable": false,
                "render": function (data, type, full, meta) {
                    return '<button type="button" class="btn btn-default selectCheckbox" data-toggle="tooltip"' +
                        'data-placement="bottom" title="@general.common.MessagesStrings.RESULTS_DATA_SELECTION">' +
                        '<span class="glyphicon glyphicon-unchecked"></span></button>';
                }
            },
            {
                "data": "id",
                "width": "1%"
            },
            {
                "data": "componentId",
                "visible": false,
                "width": "1%"
            },
            {
                "data": "studyResultId",
                "visible": false,
                "width": "1%"
            },
            {
                "data": "studyResultUuid",
                "visible": false,
                "width": "1%"
            },
            {
                "data": "studyCode",
                "visible": false,
                "width": "1%"
            },
            {
                "data": "startDate",
                 "type": "date"
            },
            {
                "data": "endDate",
                "type": "date",
                "visible": false,
                "render": (data) => data ? data : "never"
            },
            {
                "data": "duration",
                "render": (data) => data ? data : "not yet"
            },
            { "data": "batchTitle" },
            {
                "data": "workerId",
                "width": "1%",
                "render": function (data, type, full, meta) {
                    return '<a type="button" class="btn btn-worker btn-xs" data-toggle="tooltip" ' +
                        'data-placement="bottom" title="Click to get this worker\'s results" ' +
                        'href="@{general.common.Common.getPlayHttpContext()}jatos/worker/' + data + '/results">' + data + '</a>';
                }
            },
            {
                "data": "workerType",
                "render": getUIWorkerTypeWithGlyphicon
            },
            {
                "data": "groupResultId",
                "visible": false,
                "width": "1%",
                "render": function (data, type, full, meta) {
                    if (!data) return "none";
                    return '<a type="button" class="btn btn-batch btn-xs" data-toggle="tooltip" ' +
                        'data-placement="bottom" title="Click to get this group\'s results" ' +
                        'href="@{general.common.Common.getPlayHttpContext()}jatos/@study.getId()/group/' + data + '/results">' + data + '</a>';
                }
            },
            { "data": "componentState" },
            { "data": "dataSize" },
            {
                "data": "files",
                "render": function (data, type, full, meta) {
                    if (data.length === 0) return "none";
                    var resultFiles = data.map(function(fileObj) {
                        var url = "@{general.common.Common.getPlayHttpContext()}jatos/" + full.studyId + "/resultFiles/"
                            + full.studyResultId + "/" + full.id + "/" + fileObj.name;
                        return '<a href="' + url + '" download>' + fileObj.name + ' (' + fileObj.size + ')</a>';
                    });
                    return resultFiles.join("<br>");
                }
            },
            {
                "data": "message",
                "width": "20%",
                "render": (data) => data ? data : "none"
            }
        ],
        select: {
            "style": 'multi',
            "selector": 'td:nth-child(2)'
        },
        buttons: [

            {
                "extend": "colvis",
                "text": "Show/Hide Columns <span class='caret'></span>",
                "className": "btn btn-component",
                "titleAttr": '@general.common.MessagesStrings.RESULTS_CUSTOMIZATION',
                "columns": ':not(:last)'
            },
            {
                "extend": "selectAll",
                "text": "Select All",
                "className": "btn btn-component",
                "titleAttr": '@general.common.MessagesStrings.RESULTS_SELECT_ALL'
            },
            {
                "extends": "selectAll",
                "text": "Select Visible",
                "className": "btn btn-component",
                "action": function(e, dt, node, config) {
                    dt.rows({ page: 'current' }).select();
                },
                "titleAttr": '@general.common.MessagesStrings.RESULTS_SELECT_VISIBLE'
            },
            {
                "extends": "selectAll",
                "text": "Select Filtered",
                "className": "btn btn-component",
                "action": function(e, dt, node, config) {
                    dt.rows({ search: 'applied' }).select();
                },
                "titleAttr": '@general.common.MessagesStrings.RESULTS_SELECT_FILTERED'
            },
            {
                "extend": "selectNone",
                "text": "Deselect All",
                "className": "btn btn-component",
                "action": function(e, dt, node, config) {
                    dt.rows().deselect();
                },
                "titleAttr": '@general.common.MessagesStrings.RESULTS_DESELECT_ALL'
            },
        ],
        buttons: [],
        searchBuilder: {
            columns: ':not(:first-child):not(:nth-child(2)):not(th:contains(Files))'
        },
        language: {
            "lengthMenu": "Show: _MENU_",
            "searchBuilder": {
                "clearAll": "Reset",
                "title": "Custom Filter Builder",
                "data": "Field"
            }
        }
    });

    buildUpperToolbar();
    buildLowerToolbar();

    // Upper toolbar contains refresh, export, and delete button
    function buildUpperToolbar() {
        new $.fn.dataTable.Buttons(resultsTable, {
            name: 'refreshButton',
            buttons: [
                {
                    "text": "<span class='glyphicon glyphicon-refresh'></span>",
                    "className": "btn btn-component",
                    "titleAttr": 'Reload results and refresh the table',
                    "action": function ( e, dt, node, config ) {
                        this.disable();
                        resultsTable.ajax.reload();
                        setTimeout(this.enable, 3000);
                    }
                }
            ]
        });
        new $.fn.dataTable.Buttons(resultsTable, {
            name: 'exportButtonGroup',
            buttons: [
                {
                    "extend": 'collection',
                    "text": '<span class="glyphicon glyphicon-export"></span>&nbsp;Export&nbsp;Results&nbsp;<span class="caret"></span>',
                    "className": "btn btn-component",
                    "titleAttr": '@general.common.MessagesStrings.RESULTS_EXPORT_DATA',
                    "buttons": [
                        {
                            "text": "Selected",
                            "action": exportSelectedResultData,
                            "titleAttr": '@general.common.MessagesStrings.RESULTS_EXPORT_SELECTED_DATA'
                        },
                        {
                            "text": "All",
                            "action": exportAllSelectedResultData,
                            "titleAttr": '@general.common.MessagesStrings.RESULTS_EXPORT_ALL_DATA'
                        }
                    ]
                },
                {
                    "extend": 'collection',
                    "text": '<span class="glyphicon glyphicon-export"></span>&nbsp;Export&nbsp;Files&nbsp;<span class="caret"></span>',
                    "className": "btn btn-component exportFilesButton",
                    "titleAttr": '@general.common.MessagesStrings.RESULTS_EXPORT_FILES',
                    "buttons": [
                        {
                            "text": "Selected",
                            "action": exportSelectedResultFiles,
                            "titleAttr": '@general.common.MessagesStrings.RESULTS_EXPORT_SELECTED_FILES'
                        },
                        {
                            "text": "All",
                            "action": exportAllResultFiles,
                            "titleAttr": '@general.common.MessagesStrings.RESULTS_EXPORT_ALL_FILES'
                        }
                    ]
                },
                {
                    "extend": 'collection',
                    "text": '<span class="glyphicon glyphicon-export"></span>&nbsp;Export&nbsp;Metadata&nbsp;<span class="caret"></span>',
                    "className": "btn btn-component",
                    "titleAttr": '@general.common.MessagesStrings.RESULTS_EXPORT_METADATA',
                    "buttons": [
                        {
                            "extend": 'csv',
                            "text": "Selected",
                            "filename": function() { return "jatos_meta_" + getDateTimeYYYYMMDDHHmmss() },
                            "titleAttr": '@general.common.MessagesStrings.RESULTS_EXPORT_SELECTED_METADATA',
                            "exportOptions": {
                                "columns": ':nth-child(n+3):visible',
                                "modifier": {
                                    "selected": true
                                }
                            },
                            "action": function(e, dt, node, config) {
                                $(".dt-button-collection").hide();
                                $('#waitingModal').modal('show');
                                setTimeout(function(){
                                    $.fn.dataTable.ext.buttons.csvHtml5.action.call(dt.button(this), e, dt, node, config);
                                    $('#waitingModal').modal('hide');
                                }, 1000);
                            }
                        },
                        {
                            "extend": 'csv',
                            "text": "All",
                            "filename": function() { return "jatos_meta_" + getDateTimeYYYYMMDDHHmmss() },
                            "titleAttr": '@general.common.MessagesStrings.RESULTS_EXPORT_ALL_METADATA',
                            "exportOptions": {
                                "columns": ':nth-child(n+3):visible'
                            },
                            "action": function(e, dt, node, config) {
                                $(".dt-button-collection").hide();
                                $('#waitingModal').modal('show');
                                setTimeout(function(){
                                    $.fn.dataTable.ext.buttons.csvHtml5.action.call(dt.button(this), e, dt, node, config);
                                    $('#waitingModal').modal('hide');
                                }, 1000);
                            }
                        }
                    ]
                }
            ]
        });
        new $.fn.dataTable.Buttons(resultsTable, {
            name: 'deleteButton',
            buttons: [
                {
                    "extend": 'collection',
                    "text": '<span class="glyphicon glyphicon-floppy-remove"></span>&nbsp;Delete&nbsp;<span class="caret"></span>',
                    "titleAttr": "Delete results from JATOS' database",
                    "className": "btn btn-danger",
                    "buttons": [
                        {
                            "text": "Selected",
                            "action": deleteSelectedResults,
                            "titleAttr": '@general.common.MessagesStrings.RESULTS_DELETE'
                        },
                        {
                            "text": "All",
                            "action": deleteAllResults,
                            "titleAttr": '@general.common.MessagesStrings.RESULTS_DELETE_ALL'
                        }
                    ]
                }
            ]
        });

        resultsTable.buttons('refreshButton', null).containers()
            .attr('id', 'resultTable_refresh')
            .appendTo('#resultsTable_upperToolbar');
        resultsTable.buttons('exportButtonGroup', null).containers()
            .attr('id', 'resultTable_export')
            .appendTo('#resultsTable_upperToolbar');
        resultsTable.buttons('deleteButton', null).containers()
            .attr('id', 'resultTable_delete')
            .appendTo('#resultsTable_upperToolbar');
        $("#resultsTable_upperToolbar").addClass("toolbarFlexWrap");
        $("#resultTable_export").addClass("toolbarFlexWrap");
        $('#resultsTable_upperToolbar').prependTo('#resultsTable_wrapper');
    }

    // Lower toolbar contains select buttons, filter/search, SearchBuilder, customization button, and table length
    function buildLowerToolbar() {
        new $.fn.dataTable.Buttons(resultsTable, {
            name: 'selectButtonGroup',
            buttons: [
                {
                    "extend": "selectAll",
                    "text": "All",
                    "className": "btn btn-default",
                    "titleAttr": '@general.common.MessagesStrings.RESULTS_SELECT_ALL'
                },
                {
                    "extends": "selectAll",
                    "text": "Visible",
                    "className": "btn btn-default",
                    "action": function(e, dt, node, config) {
                        dt.rows().deselect();
                        dt.rows({ page: 'current' }).select();
                    },
                    "titleAttr": '@general.common.MessagesStrings.RESULTS_SELECT_VISIBLE'
                },
                {
                    "extends": "selectAll",
                    "text": "Filtered",
                    "className": "btn btn-default",
                    "action": function(e, dt, node, config) {
                        dt.rows().deselect();
                        dt.rows({ search: 'applied' }).select();
                    },
                    "titleAttr": '@general.common.MessagesStrings.RESULTS_SELECT_FILTERED'
                },
                {
                    "extend": "selectNone",
                    "text": "Deselect",
                    "className": "btn btn-default",
                    "action": function(e, dt, node, config) {
                        dt.rows().deselect();
                    },
                    "titleAttr": '@general.common.MessagesStrings.RESULTS_DESELECT_ALL'
                }
            ]
        });
        new $.fn.dataTable.Buttons(resultsTable, {
            name: 'customizeButton',
            buttons: [
                {
                    "extend": "colvis",
                    "text": "Customize <span class='caret'></span>",
                    "className": "btn btn-default",
                    "titleAttr": '@general.common.MessagesStrings.RESULTS_CUSTOMIZATION',
                    "columns": ':not(:last)'
                }
            ]
        });

        $('#resultsTable_upperToolbar').after($('#resultsTable_lowerToolbar'));
        resultsTable.buttons('selectButtonGroup', null).containers().appendTo('#resultsTable_select');
        // Swap dataTables filter field with our own
        $("#resultsTable_filter").empty();
        $("#resultsTable_select").after($('#resultsTable_search'));
        $("#resultsTable_lowerToolbar").after(resultsTable.searchBuilder.container());
        $(".dtsb-searchBuilder").addClass("collapse panel panel-default");
        resultsTable.buttons('customizeButton', null).containers().appendTo('#resultsTable_customize');
        $('#resultsTable_customize').after($('#resultsTable_length'));
    }

    // Necessary - otherwise the button doesn't work with manually selected rows
    resultsTable.on('draw', function() {
        toggleDeselectAllButton();
        toggleExportFilesButton();
    });

    resultsTable.on('select', function (e, dt, type, indexes) {
        if (type == "row") {
            resultsTable.rows(indexes).nodes().to$().each(function(index, selectedRow) {
                $(selectedRow).find('.selectCheckbox').removeClass('btn-default').addClass('btn-component');
                $(selectedRow).find('.selectCheckbox .glyphicon').removeClass('glyphicon-unchecked').addClass('glyphicon-ok');
            });
        }
    });

    resultsTable.on('deselect', function (e, dt, type, indexes) {
        if (type == "row") {
            resultsTable.rows(indexes).nodes().to$().each(function(index, selectedRow) {
                $(selectedRow).find('.selectCheckbox').removeClass('btn-component').addClass('btn-default');
                $(selectedRow).find('.selectCheckbox .glyphicon').removeClass('glyphicon-ok').addClass('glyphicon-unchecked');
            });
        }
    });

    $('#resultsTable_search input').on('keyup click', searchResultTable);

    $('#resultsTable_search button.regex, button.caseSensitive').on('click', function () {
        var button = $(this);
        if (button.hasClass('checked')) {
            button.removeClass('checked');
            button.removeClass('lightgrayBackground');
        } else {
            button.addClass('checked');
            button.addClass('lightgrayBackground');
        }
        searchResultTable();
    });

    function searchResultTable() {
        resultsTable.search(
            $('#resultsTable_search input').val(),
            $('#resultsTable_search .regex').hasClass('checked'),
            !$('#resultsTable_search .regex').hasClass('checked'),
            !$('#resultsTable_search .caseSensitive').hasClass('checked')
        ).draw();
    }

    function toggleDeselectAllButton() {
        if (resultsTable.rows('.selected').any()) {
            resultsTable.buttons(['.buttons-select-none']).enable();
        } else {
            resultsTable.buttons(['.buttons-select-none']).disable();
        }
    }

    function toggleExportFilesButton() {
        resultsTable.buttons(['.exportFilesButton']).disable();
        resultsTable.rows().data().each(function(componentResult, index) {
            if (componentResult.files.length > 0) {
                resultsTable.buttons(['.exportFilesButton']).enable();
            }
        });
    }

    $('#resultsTable tbody').on('click', 'td.details-control', function() {
        var tr = $(this).closest('tr');
        var row = resultsTable.row(tr);
        if (row.child.isShown()) {
            $('div.slider', row.child()).slideUp( function () {
                row.child.hide();
                tr.removeClass('shown');
            });
        }
        else {
            var componentResultId = row.data().id;
            $.ajax({
                url : "@{general.common.Common.getPlayHttpContext()}jatos/componentResult/" + componentResultId + "/data",
                contentType: "application/json; charset=utf-8"
            }).done(function(resultData) {
                var childRow = generateComponentResultDataChildRow(resultData, componentResultId);
                row.child(childRow).show();
                tr.addClass('shown');
                tr.next().addClass('info');
                $('div.slider', row.child()).slideDown();
            }).fail(function(err) {
                showError(err.responseText);
            });
        }
        $(this).find('.glyphicon-chevron-down, .glyphicon-chevron-right')
                .toggleClass('glyphicon-chevron-right glyphicon-chevron-down');
    });

    function exportAllSelectedResultData(e, dt, node, config) {
        exportSelectedResultData(e, dt, node, config, true);
    }

    function exportSelectedResultData(e, dt, node, config, exportAll) {
        $(".dt-button-collection").hide();
        showWaitingModal();
        var selectedTrs = exportAll ? resultsTable.rows().nodes() : resultsTable.rows('.selected').nodes();
        var ids = [];
        $.each(selectedTrs, function(index, selectedTr) {
            var rowData = resultsTable.row(selectedTr).data();
            ids.push(rowData.id);
        });
        hideWaitingModal();
        if (ids.length == 0) {
            showError("No results selected");
            return;
        }

        var url = '@controllers.gui.routes.ImportExport.exportDataOfComponentResults()';
        var data = JSON.stringify({resultIds: ids});
        var filename = "jatos_results_" + getDateTimeYYYYMMDDHHmmss() + ".txt";
        window.downloadFileStream(url, data, filename);
    }

    function deleteAllResults(e, dt, node, config) {
        deleteSelectedResults(e, dt, node, config, true);
    }

    function deleteSelectedResults(e, dt, node, config, deleteAll) {
        $(".dt-button-collection").hide();
        showWaitingModal();
        var selectedTrs = deleteAll ? resultsTable.rows().nodes() : resultsTable.rows('.selected').nodes();
        var ids = [];
        $.each(selectedTrs, function(index, selectedTr) {
            var rowData = resultsTable.row(selectedTr).data();
            ids.push(rowData.id);
        });
        if (ids.length <= 0) {
            hideWaitingModal();
            showError("No results selected");
            return;
        }

        var htmlText;
        if (deleteAll) {
            htmlText = "<p>You are about to delete <b>ALL</b> component results.</p>"
                + "<p><b>This cannot be undone.</b> Do you want to proceed?</p>";
        } else {
            htmlText = "<p>You are about to delete the component results (ID " + ids.join(", ") + ").</p>"
                + "<p><b>This cannot be undone.</b> Do you want to proceed?</p>";
        }
        var title = "Confirm Delete";
        hideWaitingModal();
        askConfirmation(title, htmlText, 'Delete', 'btn-primary', function() {
            showWaitingModal();
            $.ajax({
                url: '@controllers.gui.routes.ComponentResults.remove()',
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({resultIds: ids}),
                success: function(result) {
                    $.each(selectedTrs, function(index, selectedTr) {
                        resultsTable.row(selectedTr).remove().draw();
                    });
                },
                error: function(err) {
                    showError(err.responseText);
                },
                complete: hideWaitingModal
            });
        });
    }

    function exportAllResultFiles(e, dt, node, config) {
        exportSelectedResultFiles(e, dt, node, config, true);
    }

    function exportSelectedResultFiles(e, dt, node, config, exportAll) {
        $(".dt-button-collection").hide();
        showWaitingModal(true);
        var selectedTrs = exportAll ? resultsTable.rows().nodes() : resultsTable.rows('.selected').nodes();
        var ids = [];
        $.each(selectedTrs, function(index, selectedTr) {
            var rowData = resultsTable.row(selectedTr).data();
            ids.push(rowData.id);
        });
        hideWaitingModal();
        if (ids.length == 0) {
            showError("No results selected");
            return;
        }

        var url = '@controllers.gui.routes.ImportExport.exportResultFilesOfComponentResults()';
        var data = JSON.stringify({resultIds: ids});
        var filename = "jatos_resultfiles_" + getDateTimeYYYYMMDDHHmmss() + ".zip";
        window.downloadFileStream(url, data, filename);
    }

    function generateComponentResultDataChildRow(resultData, componentResultId) {
        var showAllButton = "";
        if (resultData.substr(resultData.length - 3) == "...") {
            showAllButton = '<button type="button" class="btn btn-xs showAllButton" data-toggle="tooltip" '
                + 'title="Show all result data of this component result.">show all</button>';
        }
        return '<div class="slider" style="display: none"><p><pre class="details-data">' + resultData + showAllButton + '</pre></p></div>';
    }

    $('#resultsTable tbody').on('click', '.showAllButton', function() {
        var componentResultId = resultsTable.row($(this).closest('tr').prev()).data().id;
        $('#componentResultDataModal .modal-title').text("Data of Component Result with ID " + componentResultId);
        $.ajax({
            url : '@controllers.gui.routes.ImportExport.exportDataOfComponentResults()',
            type : 'POST',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({resultIds: [componentResultId]}),
            success : function(result) {
                $('#componentResultDataModal .componentResultData').text(result);
                $('#componentResultDataModal').modal('show');
            },
            error : function(err) {
                showError(err.responseText);
            }
        });
    });

});

</script>

}
