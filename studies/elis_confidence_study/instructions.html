<!DOCTYPE html>

<html>
<head>
<title>Eli's confidence study - instructions</title>
<link rel="shortcut icon" type="image/png" href="/assets/images/favicon.png">
<link rel="stylesheet" href="/assets/stylesheets/jquery-ui-1.10.4.custom.min.css"/>
<link rel="stylesheet" href="/studies/elis_confidence_study/css/study.css"/>
<script src="/assets/javascripts/jquery-1.10.2.js"></script>
<script src="/assets/javascripts/jquery-ui-1.10.4.custom.min.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>

<body>

	<div id="component">
		<p id="error"></p>
		<div id="progress">
			<p id="progressBarText">Your progress</p>
			<div id="progressBar"></div>
		</div>
		<p id="text"></p>
		<p id="nextSlide">Press any key to go on.</p>
	</div>

	<script>
		var studyId = 1;
		var componentId = 1;
		var componentData;
		var jsonData;
		var slideList;
		var slideCount = 0;
		
		// When the window is fully loaded get data and display the first slide
		$(window).load(function() {
			resetSlide();
			if (!checkBrowser()) {
				return;
			}
			getComponentData(studyId, componentId);
		});
		
		// Callback function when key is pressed
		$(document).keydown(function(event) {
			// Do nothing if key is Shift, Control or Alt (AltGr doesn't seem to
			// work)
			if (event.ctrlKey || event.altKey || event.altGraphKey 
					|| event.shiftKey) {
				return;	
			}
			
			nextSlide();
		});
		
		function getComponentData(studyId, componentId) {
			$.ajax({
				url: "/publix/" + studyId + "/" + componentId + "/getData",
				type: "GET",
				dataType: 'json',
				success: function(response) {
					startComponent(response);
				},
				error: function(err) {
					showError(err.responseText);
				}
			});
		}
		
		function startComponent(response) {
			componentData = response;
			jsonData = $.parseJSON(componentData.jsonData);
			slideList = jsonData.slideList;
			nextUrl = jsonData.nextUrl;
			document.title = componentData.title;
			displaySlide();
		}

		function displaySlide() {
			$("#progress").show();
			var progressValue = ((slideCount + 1) / slideList.length) * 100;
			$("#progressBar").progressbar({value: progressValue});
			var text = slideList[slideCount].text;
			$("#text").html(text).show()
			$("#nextSlide").show();
		}
		
		function nextSlide() {
			slideCount++;
			if (slideCount < slideList.length) {
				displaySlide();
			} else {
				endComponentAndNext();
			}
		}
		
		function endComponentAndNext() {
			window.location.href = "/publix/" + studyId + "/startNextComponent";
		}
		
		function showError(errorMsg) {
			resetSlide();
			$("#error").html(errorMsg).show();
		}
		
		function resetSlide() {
			$("#component").children().hide();
			$("#progressBar").progressbar({disabled: true});
		}
		
		function checkBrowser() {
			var userAgent = navigator.userAgent;
			var logErrorMsg;
			// Check mobile phones and tablets
			if (userAgent.match(
					/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i)) {
				showError("Sorry, you can't do this questionaire on a mobile or a tablet.");
				logErrorMsg = "Mobile phone browser not supported: component "
					+ component.id + ", userAgent \"" + userAgent + "\"";
			}
			
			// Check if browser supports perfomance.now feature
			if (!performance.now) {
				showError("Sorry, you can't do this questionaire with this browser.");
				var logErrorMsg = "Browser doesn't support perfomance.now: component "
					+ component.id + ", userAgent \"" + userAgent + "\"";
			}
			
			if (logErrorMsg) {
				// Send error msg for logging to server
				$.ajax({
					url: "/publix/logError",
					data: logErrorMsg,
					processData: false,
					type: "POST",
					contentType: "text/plain"
				});
				return false;
			}
			return true;
		}
		
	</script>
</body>
</html>