@(studyList: List[StudyModel], loggedInUser: UserModel, 
breadcrumbs: services.Breadcrumbs, messages: services.Messages,
study: StudyModel, component: ComponentModel)

@views.html.mecharg.main(studyList, loggedInUser, breadcrumbs, messages){

<!-- Toolbar -->
<div id="resultsToolbar" class="btn-toolbar pull-right" role="toolbar">
	<div class="btn-group" aria-hidden="true">
		<button type="button" class="exportData btn btn-primary btn-sm">Export Data</button>
		<button type="button" class="remove btn btn-primary btn-sm">Delete</button>
	</div>
</div>

<table id="resultsTable" class="table table-hover table-row-border" cellpadding="0" cellspacing="0" border="0" width="100%">
	<thead>
		<tr>
			<th></th>
			<th>Result ID</th>
			<th>Time</th>
			<th>Worker ID</th>
			<th>Worker Type</th>
			<th>State</th>
			<th>Error Message</th>
		</tr>
	</thead>
	<tfoot>
		<tr>
			<th></th>
			<th>Result ID</th>
			<th>Time</th>
			<th>Worker ID</th>
			<th>Worker Type</th>
			<th>State</th>
			<th>Error Message</th>
		</tr>
	</tfoot>
</table>

<script type="text/javascript">

var resultsTable;
$(document).ready(function() {
	resultsTable = $('#resultsTable').DataTable({
		"ajax": {
			"type": "GET",
			"url" : "@routes.ComponentResults.tableDataByComponent(study.getId(),component.getId())",
			"error": function(reason) {
					showError("Couldn't read results data.")
			}
		},
		"order": [[ 2, "desc" ]],
		"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
		"pageLength": 10,
		"columns": [
			{
				"class": 'details-control',
				"orderable": false,
				"data": null,
				"defaultContent": ''
			},
			{ "data": "id" },
			{
				"class": 'time',
				"data": "startDate"
			},
			{
				"data": "workerId",
				"render": function (data, type, full, meta) {
					return '<a href="/mecharg/worker/'
						+ data + '">' + data + '</a>';
				}
			},
			{ "data": "workerType" },
			{ "data": "componentState" },
			{ 
				"data": "errorMsg",
				"width": "20%"
			}
		]
	});
	var tableTools = new $.fn.dataTable.TableTools(resultsTable, {
		"sRowSelect": "multi",
		"aButtons": [ "select_all", "select_none" ],
		"sRowSelector": "td:not(:first-child):not(:last-child)"
	});
	$(tableTools.fnContainer()).appendTo('div.btn-toolbar');
	
	$('#resultsTable tbody').on('click', 'td.details-control', function() {
		var tr = $(this).closest('tr');
		var row = resultsTable.row(tr);
		if (row.child.isShown()) {
			row.child.hide();
			tr.removeClass('shown');
		}
		else {
			row.child(childRowFormat(row.data())).show();
			tr.addClass('shown');
			tr.next().addClass('info');
		}
	});
});

$('#resultsToolbar').on('click', '.exportData', function() {
	var oTT = TableTools.fnGetInstance('resultsTable');
	var selectedTrs = oTT.fnGetSelected();
	var ids = [];
	selectedTrs.forEach(function(selectedTr) {
		var rowData = resultsTable.row(selectedTr).data();
		ids.push(rowData.id);
	});
	if(ids.length == 0) {
		showError("No results selected");
		return;
	}
	var url = '/mecharg/componentresult/'
		+ 'exportData?componentResultIds=' + ids.toString();
	$.fileDownload(url)
		.fail(function () { showError("Export of results failed"); });
	return false; //this is critical to stop the click event which will trigger a normal file download
});

$('#resultsToolbar').on('click', '.remove', function() {
	var oTT = TableTools.fnGetInstance('resultsTable');
	var selectedTrs = oTT.fnGetSelected();
	var ids = [];
	selectedTrs.forEach(function(selectedTr) {
		var rowData = resultsTable.row(selectedTr).data();
		ids.push(rowData.id);
	});
	if(ids.length <= 0) {
		showError("No results selected");
		return;
	}
	var title = "Confirm Delete";
	var text = "You are about to delete the component results "
		+ "(ID " + ids.toString() + ").";
	askConfirmation(title, text, 'Delete', function() {
		var url = '/mecharg/componentresult/remove?componentResultIds=' + ids.toString();
		$.ajax({
			url : url,
			type : 'GET',
			success : function(result) {
				selectedTrs.forEach(function(selectedTr) {
					resultsTable.row(selectedTr).remove().draw();
				});
			},
			error : function(err) {
				showError(err.responseText);
			}
		});
	});
});

function childRowFormat(data) {
	// `data` is the original data object for the row
	return '<p><pre class="details-data">' + data.data + '</pre></p>';
}

</script>

}
