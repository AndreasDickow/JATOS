<!DOCTYPE html>

<html>
<head>
<title>Basic Example Study</title>
<link rel="shortcut icon" type="image/png" href="/study_assets/basic_example_study/images/favicon.png">
<link rel="stylesheet" href="/study_assets/basic_example_study/css/basic_example_study.css"/>
<script src="/study_assets/basic_example_study/libs/jquery-1.11.1.min.js"></script>
<script src="/assets/javascripts/jatos.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>

<body>

	<div id="component">
		<p id="error"></p>
		<p id="progressText"></p>
		<p id="text"></p>
		<p id="moveSlidesText">Press F to continue to the next slide, or press B to go back one slide</p>
		<p id="moveComponentsText">Press 1 to go to the next component<br>Press 2 to go to 2 components ahead<br>Press 3 to go to 2 components back.<br>Press 4 to go to the component called "read URL parameter",<br>and send what you write in this text box below:</p>
		<textarea maxlength="20" id="URLparamsTextBox" placeholder="Enter text here..."></textarea>
	</div>

	<script>
		var slideList;
		var slideCount = 0;
		var fwdSlide = 70; // 78 is JavaScript code for keyboard F
		var backSlide = 66; // 66 is JavaScript code for keyboard B
		var plusOneComponent = 49; // 49 is JavaScript code for keyboard 1
		var plusTwoComponent = 50; // 50 is JavaScript code for keyboard 2
		var minusTwoComponent = 51; // 51 is JavaScript code for keyboard 3
		var jumpToComponent = 52; // 52 is JavaScript code for keyboard 4

		var componentState = Object.freeze({
			RUNNING: 0, WAITING: 1, FINISHED: 2, ERROR: 3
		});
		var currentComponentState = componentState.WAITING;
		
		// What todo when jatos.js is finished initializing
		jatos.onLoad(function() {
			currentComponentState = componentState.RUNNING;
			resetSlide();
			startComponent();
		});

		// What todo when jatos.js produces an error
		jatos.onError(function(errorMsg) {
			showError(errorMsg);
		});
		
		// What todo when key is pressed
		$(document).keydown(function(event) {
			// Do nothing if key is Shift, Control or Alt (AltGr doesn't seem to work)
			if (event.ctrlKey || event.altKey || event.altGraphKey 
					|| event.shiftKey) {
				return;	
			}

			switch (currentComponentState) {
			case componentState.RUNNING:

				var keycode = (event.keyCode ? event.keyCode : event.which);
				if (keycode == fwdSlide){
					nextSlide();
				} else if (keycode == backSlide){
					prevSlide();
				}
				return;
			case componentState.FINISHED:
				var keycode = (event.keyCode ? event.keyCode : event.which);
				getJumpingOption(keycode);
				return;
			case componentState.ERROR:
				finishStudyWithError();
				return;
			}
		});


		function startComponent() {
			document.title = jatos.componentData.title;
			slideList = jatos.componentJsonData.slideList;
			displaySlide();
		}

		function displaySlide() {
			var progressText = (slideCount + 1) + " of " + slideList.length + " component slides <br> " + (slideCount + jatos.componentJsonData.startingSlide) + " of " + jatos.studyJsonData.totalStudySlides + " total study slides"; 
			var text = slideList[slideCount].text;
			$("#progressText").html(progressText).show();
			$("#text").html(text).show()
			if (slideCount + 1 < slideList.length){
				$("#moveSlidesText").show();			
			} else {
				$("#moveSlidesText").hide();
				$("#moveComponentsText").show();
				$("#URLparamsTextBox").show();
				currentComponentState = componentState.FINISHED; // to distinguish last slides from all others			
			}
		}
		
		function nextSlide() {
			slideCount++;
			if (slideCount < slideList.length) {
				displaySlide();
			} else {
				jatos.startNextComponent();
			}
		}

		function prevSlide() {
			slideCount--;
			if (slideCount >= 0) {
				displaySlide();
			} else {
				slideCount = 0;
			}
		}
		
		function getJumpingOption(keycode) { 
			switch (keycode) {
				case plusOneComponent:
					jatos.startNextComponent();
					return;
				case plusTwoComponent:
					jatos.startComponentByPos(parseInt(jatos.componentPos) + 2);
					return;
				case minusTwoComponent:
					jatos.startComponentByPos(parseInt(jatos.componentPos) - 2);
					return;
				case jumpToComponent:
					var URLtext = document.getElementById("URLparamsTextBox").value;
					jatos.startComponent(26, "myURLparam=" + URLtext);
					return;
			} 
		}

		function showError(errorMsg) {
			resetSlide();
			currentComponentState = componentState.ERROR;
			window.errorMsg = errorMsg;
			$("#error").html(errorMsg).show();
		}
		
		function resetSlide() {
			$("#component").children().hide();
		}

		function finishStudyWithError() {
			currentComponentState = componentState.FINISHED;
			jatos.endComponent(false,  window.errorMsg, jatos.endStudy(false, window.errorMsg));
		}
		
	</script>
</body>
</html>
